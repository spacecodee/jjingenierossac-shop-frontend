<main class="container-layout flex flex-col min-h-full">
  <section hlmCard class="card-elevated flex flex-col overflow-visible">
    <header hlmCardHeader>
      <div class="flex items-start justify-between gap-4 flex-col sm:flex-row">
        <div class="flex-1">
          <h1 hlmCardTitle class="text-2xl font-bold">Historial de Movimientos de Inventario</h1>
          <p hlmCardDescription class="text-sm text-muted-foreground mt-1">
            Consulta el historial completo de todos los movimientos de inventario
          </p>
        </div>
        <div class="flex items-center gap-2">
          <button
            hlmBtn
            variant="outline"
            size="sm"
            (click)="onRefresh()"
            [disabled]="isRefreshing()"
            class="flex items-center gap-2 cursor-pointer"
          >
            @if (isRefreshing()) {
              <hlm-spinner size="sm"/>
            } @else {
              <ng-icon hlm size="sm" name="lucideRefreshCw"/>
            }
            <span>Actualizar</span>
          </button>
        </div>
      </div>
    </header>

    <hlm-separator class="my-4"/>

    <div hlmCardContent class="flex-shrink-0">
      <div class="flex flex-col gap-4">
        <div class="flex flex-col sm:flex-row gap-3">
          <div class="relative flex-1">
            <ng-icon
              hlm
              size="sm"
              name="lucideSearch"
              class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none"
            />
            <input
              hlmInput
              type="text"
              placeholder="Buscar en producto, notas, proveedor, usuario..."
              [value]="searchInputValue()"
              (input)="onSearchInput($any($event.target).value)"
              class="pl-10 pr-10"
            />
            @if (searchInputValue()) {
              <button
                hlmBtn
                variant="ghost"
                size="sm"
                (click)="onClearSearch()"
                class="absolute right-2 top-1/2 -translate-y-1/2"
              >
                <ng-icon hlm size="sm" name="lucideX"/>
              </button>
            }
          </div>

          <button
            hlmBtn
            variant="outline"
            size="default"
            (click)="toggleFilters()"
            class="flex items-center gap-2 cursor-pointer"
          >
            <ng-icon hlm size="sm" name="lucideSlidersHorizontal"/>
            <span>Filtros</span>
            @if (hasFiltersApplied()) {
              <span class="text-xs text-primary">●</span>
            }
          </button>

          <button
            hlmBtn
            variant="outline"
            size="default"
            (click)="toggleDateFilters()"
            class="flex items-center gap-2 cursor-pointer"
          >
            <ng-icon hlm size="sm" name="lucideCalendar"/>
            <span>Filtros de Fechas</span>
            @if (dateFrom() || dateTo()) {
              <span class="text-xs text-primary">●</span>
            }
          </button>
        </div>

        @if (hasFiltersApplied()) {
          <div class="flex items-center gap-2">
            <button
              hlmBtn
              variant="ghost"
              size="sm"
              (click)="onClearFilters()"
              class="flex items-center gap-2 cursor-pointer"
            >
              <ng-icon hlm size="sm" name="lucideX"></ng-icon>
              <span>Limpiar filtros</span>
            </button>
          </div>
        }
      </div>

      @if (showDateFilters()) {
        <div class="pt-4 border-t mt-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="flex flex-col gap-3">
              <span class="text-sm font-medium">Desde (Fecha)</span>
              <hlm-date-picker
                buttonId="dateFrom"
                [date]="dateFrom()"
                (dateChange)="onDateFromChange($event)"
              >
                <span>Seleccionar fecha</span>
              </hlm-date-picker>
            </div>

            <div class="flex flex-col gap-3">
              <span class="text-sm font-medium">Hasta (Fecha)</span>
              <hlm-date-picker
                buttonId="dateTo"
                [date]="dateTo()"
                (dateChange)="onDateToChange($event)"
              >
                <span>Seleccionar fecha</span>
              </hlm-date-picker>
            </div>
          </div>
        </div>
      }
    </div>

    <hlm-separator class="my-4"/>

    <div hlmCardContent class="flex-1 overflow-hidden flex flex-col min-h-0">
      <div class="overflow-x-auto flex-1">
        <table hlm class="w-full">
          <thead hlmThead>
          <tr hlmTr>
            <th
              hlmTh
              class="cursor-pointer"
              (click)="onSort('createdAt')"
              (keydown.enter)="onSort('createdAt')"
              tabindex="0"
            >
              Fecha/Hora @if (sortField() === 'createdAt') {
              <span class="ml-1">{{ sortDirection() === 'ASC' ? '↑' : '↓' }}</span>
            }
            </th>
            <th
              hlmTh
              class="cursor-pointer"
              (click)="onSort('movementType')"
              (keydown.enter)="onSort('movementType')"
              tabindex="0"
            >
              Tipo @if (sortField() === 'movementType') {
              <span class="ml-1">{{ sortDirection() === 'ASC' ? '↑' : '↓' }}</span>
            }
            </th>
            <th
              hlmTh
              class="cursor-pointer"
              (click)="onSort('productName')"
              (keydown.enter)="onSort('productName')"
              tabindex="0"
            >
              Producto @if (sortField() === 'productName') {
              <span class="ml-1">{{ sortDirection() === 'ASC' ? '↑' : '↓' }}</span>
            }
            </th>
            <th
              hlmTh
              class="cursor-pointer"
              (click)="onSort('quantityChange')"
              (keydown.enter)="onSort('quantityChange')"
              tabindex="0"
            >
              Cantidad @if (sortField() === 'quantityChange') {
              <span class="ml-1">{{ sortDirection() === 'ASC' ? '↑' : '↓' }}</span>
            }
            </th>
            <th
              hlmTh
              class="cursor-pointer"
              (click)="onSort('userName')"
              (keydown.enter)="onSort('userName')"
              tabindex="0"
            >
              Usuario @if (sortField() === 'userName') {
              <span class="ml-1">{{ sortDirection() === 'ASC' ? '↑' : '↓' }}</span>
            }
            </th>
            <th hlmTh>Proveedor</th>
            <th hlmTh>Notas</th>
            <th hlmTh class="text-right">Acciones</th>
          </tr>
          </thead>
          <tbody hlmTbody>
            @if (isLoading()) {
              @for (_ of [1, 2, 3, 4, 5]; track $index) {
                <tr hlmTr>
                  <td hlmTd>
                    <hlm-skeleton class="h-5 w-32"/>
                  </td>
                  <td hlmTd>
                    <hlm-skeleton class="h-5 w-20"/>
                  </td>
                  <td hlmTd>
                    <hlm-skeleton class="h-5 w-40"/>
                  </td>
                  <td hlmTd>
                    <hlm-skeleton class="h-5 w-16"/>
                  </td>
                  <td hlmTd>
                    <hlm-skeleton class="h-5 w-32"/>
                  </td>
                  <td hlmTd>
                    <hlm-skeleton class="h-5 w-32"/>
                  </td>
                  <td hlmTd>
                    <hlm-skeleton class="h-5 w-48"/>
                  </td>
                  <td hlmTd class="text-right">
                    <hlm-skeleton class="h-8 w-20 ml-auto"/>
                  </td>
                </tr>
              }
            } @else if (displayedMovements().length === 0) {
              <tr hlmTr>
                <td hlmTd [attr.colspan]="8" class="text-center py-8">
                  <p class="text-muted-foreground">
                    No se encontraron movimientos que coincidan con los filtros aplicados.
                  </p>
                  <p class="text-sm text-muted-foreground mt-1">
                    Intente modificar los criterios de búsqueda o limpiar filtros.
                  </p>
                </td>
              </tr>
            } @else {
              @for (movement of displayedMovements(); track movement.movementId) {
                <tr hlmTr>
                  <td hlmTd class="font-mono text-sm">
                    {{ movement.createdAt | date : 'dd/MM/yyyy HH:mm' }}
                  </td>
                  <td hlmTd>
                <span hlmBadge [variant]="getMovementTypeBadgeVariant(movement.movementType)">
                  {{ getMovementTypeLabel(movement.movementType) }}
                </span>
                  </td>
                  <td hlmTd>
                    <div class="flex flex-col">
                      <span class="font-medium">{{ movement.product.name }}</span>
                      <span class="text-xs text-muted-foreground">
                    ID: {{ movement.product.productId }}
                  </span>
                    </div>
                  </td>
                  <td hlmTd>
                <span [class]="getQuantityClass(movement.quantityChange)">
                  {{ formatQuantity(movement.quantityChange) }}
                </span>
                  </td>
                  <td hlmTd>
                    @if (movement.user) {
                      <div class="flex flex-col">
                        <span class="font-medium">{{ movement.user.fullName }}</span>
                        <span class="text-xs text-muted-foreground">
                    &#64;{{ movement.user.username }}
                  </span>
                      </div>
                    } @else {
                      <span class="text-muted-foreground">—</span>
                    }
                  </td>
                  <td hlmTd>
                    @if (movement.supplier) {
                      <div class="flex flex-col">
                        <span class="font-medium">{{ movement.supplier.name }}</span>
                        @if (movement.supplier.taxId) {
                          <span class="text-xs text-muted-foreground">
                    RUC: {{ movement.supplier.taxId }}
                  </span>
                        }
                      </div>
                    } @else {
                      <span class="text-muted-foreground">—</span>
                    }
                  </td>
                  <td hlmTd>
                    @if (movement.notes) {
                      <span class="text-sm">{{ movement.notes }}</span>
                    } @else {
                      <span class="text-muted-foreground">—</span>
                    }
                  </td>
                  <td hlmTd class="text-right">
                    <button
                      hlmBtn
                      variant="ghost"
                      size="sm"
                      class="cursor-pointer"
                      (click)="onViewDetail(movement)"
                    >
                      <ng-icon hlm size="sm" name="lucideEye"/>
                      <span *brnTooltipContent class="text-xs">Ver detalles</span>
                    </button>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </div>

    <hlm-separator class="my-4"/>

    <footer hlmCardFooter class="flex-shrink-0">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-2">
          <span class="text-sm text-muted-foreground">Elementos por página:</span>
          <brn-select
            class="inline-block"
            [(ngModel)]="pageSize"
            (ngModelChange)="onPageSizeChange($event)"
          >
            <hlm-select-trigger class="w-20">
              <hlm-select-value/>
            </hlm-select-trigger>
            <hlm-select-content>
              <hlm-option [value]="10">10</hlm-option>
              <hlm-option [value]="20">20</hlm-option>
              <hlm-option [value]="50">50</hlm-option>
            </hlm-select-content>
          </brn-select>
          <span class="text-sm text-muted-foreground">
            Mostrando {{ Math.min(currentPage() * pageSize() + 1, totalElements()) }} -
            {{ Math.min((currentPage() + 1) * pageSize(), totalElements()) }} de
            {{ totalElements() }} movimientos
          </span>
        </div>

        @if (totalPages() > 1) {
          <nav hlmPagination class="mx-auto sm:mx-0">
            <ul hlmPaginationContent>
              <li hlmPaginationItem>
                <button
                  hlmPaginationLink
                  link="first"
                  size="default"
                  [disabled]="isFirst()"
                  (click)="goToPage(0)"
                >
                  <ng-icon hlm size="sm" name="lucideChevronsLeft"/>
                </button>
              </li>
              <li hlmPaginationItem>
                <button
                  hlmPaginationLink
                  link="previous"
                  size="default"
                  [disabled]="isFirst()"
                  (click)="goToPage(currentPage() - 1)"
                >
                  <ng-icon hlm size="sm" name="lucideChevronLeft"/>
                </button>
              </li>

              @for (pageNumber of pageNumbers(); track $index) {
                @if (pageNumber === 'ellipsis') {
                  <li hlmPaginationItem>
                    <span hlmPaginationEllipsis>...</span>
                  </li>
                } @else {
                  <li hlmPaginationItem>
                    <button
                      hlmPaginationLink
                      size="default"
                      [isActive]="pageNumber === currentPage()"
                      (click)="goToPage(+pageNumber)"
                    >
                      {{ +pageNumber + 1 }}
                    </button>
                  </li>
                }
              }

              <li hlmPaginationItem>
                <button
                  hlmPaginationLink
                  link="next"
                  size="default"
                  [disabled]="isLast()"
                  (click)="goToPage(currentPage() + 1)"
                >
                  <ng-icon hlm size="sm" name="lucideChevronRight"/>
                </button>
              </li>
              <li hlmPaginationItem>
                <button
                  hlmPaginationLink
                  link="last"
                  size="default"
                  [disabled]="isLast()"
                  (click)="goToPage(totalPages() - 1)"
                >
                  <ng-icon hlm size="sm" name="lucideChevronsRight"/>
                </button>
              </li>
            </ul>
          </nav>
        }
      </div>
    </footer>
  </section>
</main>
